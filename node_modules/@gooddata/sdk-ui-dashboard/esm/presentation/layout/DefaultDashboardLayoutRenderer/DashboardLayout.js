import { __assign } from "tslib";
// (C) 2007-2022 GoodData Corporation
import React, { useCallback, useMemo } from "react";
import { Container, ScreenClassProvider, ScreenClassRender, setConfiguration, } from "react-grid-system";
import { DashboardLayoutSection } from "./DashboardLayoutSection";
import cx from "classnames";
import stringify from "json-stable-stringify";
import { DashboardLayoutFacade } from "../../../_staging/dashboard/fluidLayout/facade/layout";
import { getResizedItemPositions, unifyDashboardLayoutItemHeights, getLayoutWithoutGridHeights, } from "./utils/sizing";
import isEqual from "lodash/isEqual";
import { DASHBOARD_LAYOUT_GRID_CONFIGURATION } from "../../constants";
import { emptyDOMRect } from "../constants";
setConfiguration(DASHBOARD_LAYOUT_GRID_CONFIGURATION);
var removeHeights = function (layout, enableCustomHeight) {
    if (enableCustomHeight) {
        return layout;
    }
    return getLayoutWithoutGridHeights(layout);
};
/**
 * DashboardLayout is customizable component for rendering {@link IDashboardLayout}.
 *
 * @alpha
 */
export function DashboardLayout(props) {
    var layout = props.layout, _a = props.sectionKeyGetter, sectionKeyGetter = _a === void 0 ? function (_a) {
        var section = _a.section;
        return section.index();
    } : _a, sectionRenderer = props.sectionRenderer, sectionHeaderRenderer = props.sectionHeaderRenderer, itemKeyGetter = props.itemKeyGetter, itemRenderer = props.itemRenderer, widgetRenderer = props.widgetRenderer, gridRowRenderer = props.gridRowRenderer, className = props.className, debug = props.debug, onMouseLeave = props.onMouseLeave, enableCustomHeight = props.enableCustomHeight, _b = props.renderMode, renderMode = _b === void 0 ? "view" : _b;
    var layoutRef = React.useRef(null);
    var _c = useMemo(function () {
        var updatedLayout = removeHeights(layout, !!enableCustomHeight);
        var layoutFacade = DashboardLayoutFacade.for(unifyDashboardLayoutItemHeights(updatedLayout));
        var resizedItemPositions = getResizedItemPositions(layout, layoutFacade.raw());
        return { layoutFacade: layoutFacade, resizedItemPositions: resizedItemPositions };
    }, [layout, enableCustomHeight]), layoutFacade = _c.layoutFacade, resizedItemPositions = _c.resizedItemPositions;
    var sectionRendererWrapped = useCallback(function (renderProps) {
        return sectionRenderer ? (sectionRenderer(__assign(__assign({}, renderProps), { debug: debug }))) : (React.createElement(renderProps.DefaultSectionRenderer, __assign({}, renderProps, { debug: debug })));
    }, [debug, sectionRenderer]);
    var getLayoutDimensions = useCallback(function () {
        return (layoutRef === null || layoutRef === void 0 ? void 0 : layoutRef.current) ? layoutRef.current.getBoundingClientRect() : emptyDOMRect;
    }, []);
    var widgetRendererWrapped = useCallback(function (renderProps) {
        var isResizedByLayoutSizingStrategy = resizedItemPositions.some(function (position) {
            return isEqual(position, [renderProps.item.section().index(), renderProps.item.index()]);
        });
        return widgetRenderer ? (widgetRenderer(__assign(__assign({}, renderProps), { isResizedByLayoutSizingStrategy: isResizedByLayoutSizingStrategy,
            debug: debug, getLayoutDimensions: getLayoutDimensions }))) : (React.createElement(renderProps.DefaultWidgetRenderer, __assign({}, renderProps, { debug: debug, isResizedByLayoutSizingStrategy: isResizedByLayoutSizingStrategy, getLayoutDimensions: getLayoutDimensions })));
    }, [debug, stringify(resizedItemPositions), widgetRenderer]);
    return (React.createElement("div", { className: cx("gd-fluidlayout-container", "s-fluid-layout-container", "gd-dashboards", className), onMouseLeave: onMouseLeave, ref: layoutRef },
        React.createElement(ScreenClassProvider, { useOwnWidth: false },
            React.createElement(ScreenClassRender, { render: function (screenClass) {
                    var screen = screenClass;
                    return screen ? (React.createElement(Container, { fluid: true, className: "gd-fluidlayout-layout s-fluid-layout" }, layoutFacade.sections().map(function (section) {
                        return (React.createElement(DashboardLayoutSection, { key: sectionKeyGetter({ section: section, screen: screen }), section: section, sectionRenderer: sectionRendererWrapped, sectionHeaderRenderer: sectionHeaderRenderer, itemKeyGetter: itemKeyGetter, itemRenderer: itemRenderer, gridRowRenderer: gridRowRenderer, widgetRenderer: widgetRendererWrapped, screen: screen, renderMode: renderMode, getLayoutDimensions: getLayoutDimensions }));
                    }))) : null;
                } }))));
}
//# sourceMappingURL=DashboardLayout.js.map